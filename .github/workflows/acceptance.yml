name: A0 Acceptance (fin-infra)

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - 'feat/**'
      - 'feature/**'
      - 'release/**'
  pull_request:
    branches: ["*"]

jobs:
  acceptance:
    name: Acceptance
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        profile: [in-memory, redis]
    permissions:
      contents: read
      id-token: write
    env:
      ALPHAVANTAGE_API_KEY: ${{ secrets.ALPHAVANTAGE_API_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry 2.x
        run: |
          python -m pip install --upgrade pip pipx
          pipx install "poetry==2.0.1"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          poetry --version

      - name: Repair or create lockfile
        id: relock
        run: |
          set -euo pipefail
          if [ -f poetry.lock ]; then
            echo "Validating existing lockfile…"
            if poetry lock --no-interaction; then
              echo "lock_status=kept" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "Lockfile invalid. Removing and recreating…"
              rm -f poetry.lock
            fi
          fi
          poetry lock --no-interaction
          echo "lock_status=recreated" >> $GITHUB_OUTPUT

      - name: Install deps (main + dev)
        run: poetry install --only main,dev --sync --no-interaction

      - name: Run unit tests
        run: poetry run pytest -q tests/unit

      - name: Select profile env
        if: matrix.profile == 'redis'
        run: echo "COMPOSE_PROFILES=redis" >> "$GITHUB_ENV"

      - name: Echo acceptance context
        run: |
          echo "Matrix profile: ${{ matrix.profile }}"
          echo "AlphaVantage key configured: $([ -n "$ALPHAVANTAGE_API_KEY" ] && echo yes || echo no)"

      - name: Run acceptance (Makefile)
        run: make accept

      - name: Generate SBOM (CycloneDX JSON)
        uses: anchore/sbom-action@v0
        with:
          path: .
          artifact-name: fin-infra-sbom-${{ github.run_id }}-${{ github.run_attempt }}
          output-file: sbom.cdx.json
          format: cyclonedx-json

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-cdx-${{ github.run_id }}-${{ github.run_attempt }}
          path: sbom.cdx.json

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign SBOM (keyless)
        env:
          COSIGN_YES: 'true'
        run: |
          cosign version
          cosign sign-blob \
            --output-signature sbom.cdx.json.sig \
            --output-certificate sbom.cdx.json.crt \
            sbom.cdx.json

      - name: Upload SBOM signature artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-signature-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            sbom.cdx.json.sig
            sbom.cdx.json.crt
